// courses/:courseCode/assessments/:assessmentId/grade - VERSI√ìN CON PALETA JUVENIL MODERNA
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '@/contexts/AuthContext';
import { useAcademic } from '@/contexts/AcademicContext';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { assessmentService } from '@/lib/services/assessmentService';
import { gradeSheetService } from '@/lib/services/gradeSheetService';
import { submissionService } from '@/lib/services/submissionService';
import { enrollmentService } from '@/lib/firestore';
import { collection, query, where, getDocs } from 'firebase/firestore';
import { db } from '@/lib/firebase';
import { toast } from 'sonner';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import {
  ArrowLeft, 
  Save, 
  Users, 
  FileText, 
  Calendar,
  Percent,
  AlertCircle,
  CheckCircle,
  FileSpreadsheet,
  MessageSquare,
  Eye,
  Download,
  Clock,
  CalendarClock,
  AlertTriangle,
  ChevronDown,
  ChevronUp,
  File,
  ExternalLink,
  BookOpen,
  Search,
  Filter,
  Loader2,
  Sparkles,
  Zap,
  Target,
  Trophy,
  BarChart3,
  TrendingUp,
  Award,
  Bookmark,
  Shield,
  Activity,
  LineChart,
  PieChart,
  CheckSquare,
  XCircle,
  FileCheck,
  FileBarChart,
  UserCheck
} from 'lucide-react';

interface StudentGrade {
  studentId: string;
  name: string;
  email?: string;
  grade?: number;
  comment?: string;
  status: 'pending' | 'graded' | 'completed' | 'incomplete';
  submittedAt?: Date | null;
  submission?: any;
  hasSubmission?: boolean;
  submissionStatus?: 'draft' | 'submitted' | 'graded' | 'pending' | 'no_submission' ;

  submissionContent?: string;
  wordCount?: number;
  characterCount?: number;
  submissionDate?: Date;
}

interface FirestoreGrade {
  value: number;
  comment: string;
  submittedAt: Date;
}

interface ExpandedSubmissions {
  [studentId: string]: boolean;
}

export default function GradeAssessmentPage() {
  const { courseCode, assessmentId } = useParams<{ courseCode: string; assessmentId: string }>();
  const { user } = useAuth();
  const { courses } = useAcademic();
  const navigate = useNavigate(); 
  
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [assessment, setAssessment] = useState<any>(null);
  const [gradeSheet, setGradeSheet] = useState<any>(null);
  const [students, setStudents] = useState<StudentGrade[]>([]);
  const [courseName, setCourseName] = useState('');
  const [courseId, setCourseId] = useState<string>('');
  
  const [expandedSubmissions, setExpandedSubmissions] = useState<ExpandedSubmissions>({});
  const [activeTab, setActiveTab] = useState<'grades' | 'submissions'>('grades');
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState<string>('all');

  // Funci√≥n para obtener color de tipo de evaluaci√≥n
  const getTypeColor = (type: string) => {
    switch (type) {
      case 'exam': return 'bg-gradient-to-br from-red-100 to-pink-100 text-red-700 border border-red-200';
      case 'quiz': return 'bg-gradient-to-br from-blue-100 to-cyan-100 text-blue-700 border border-blue-200';
      case 'homework': return 'bg-gradient-to-br from-green-100 to-emerald-100 text-green-700 border border-green-200';
      case 'project': return 'bg-gradient-to-br from-purple-100 to-pink-100 text-purple-700 border border-purple-200';
      case 'participation': return 'bg-gradient-to-br from-amber-100 to-orange-100 text-amber-700 border border-amber-200';
      case 'delivery': return 'bg-gradient-to-br from-cyan-100 to-blue-100 text-cyan-700 border border-cyan-200';
      default: return 'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 border border-gray-300';
    }
  };

  // Funci√≥n para obtener √≠cono de tipo
  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'exam': return <FileText className="h-4 w-4" />;
      case 'quiz': return <BookOpen className="h-4 w-4" />;
      case 'homework': return <FileCheck className="h-4 w-4" />;
      case 'project': return <TrendingUp className="h-4 w-4" />;
      case 'participation': return <Users className="h-4 w-4" />;
      case 'delivery': return <FileBarChart className="h-4 w-4" />;
      default: return <FileText className="h-4 w-4" />;
    }
  };

  const loadSubmissionsDirectly = async (assessmentId: string): Promise<any[]> => {
    try {
      console.log('üîç Cargando entregas directamente de Firestore para assessmentId:', assessmentId);
      
      const q = query(
        collection(db, 'submissions'),
        where('assessmentId', '==', assessmentId)
      );
      
      
      const querySnapshot = await getDocs(q);
      console.log('‚úÖ Documentos encontrados en Firestore:', querySnapshot.size);
      
      const submissions: any[] = [];
      querySnapshot.forEach((doc) => {
      const data = doc.data();

    
     let submittedAt = null;
      if (data.submittedAt) {
        if (data.submittedAt.toDate) {
          submittedAt = data.submittedAt.toDate();
        } else if (data.submittedAt.seconds) {
          submittedAt = new Date(data.submittedAt.seconds * 1000);
        } else if (typeof data.submittedAt === 'string') {
          submittedAt = new Date(data.submittedAt);
        }
      }

        
        let updatedAt = null;
        if (data.updatedAt) {
          if (data.updatedAt.toDate) {
            updatedAt = data.updatedAt.toDate();
          } else if (data.updatedAt.seconds) {
            updatedAt = new Date(data.updatedAt.seconds * 1000);
          } else if (typeof data.updatedAt === 'string') {
            updatedAt = new Date(data.updatedAt);
          }
        }
        
                 const actualStatus = submittedAt ? 'submitted' : (data.status || 'draft');
 
         submissions.push({
        id: doc.id,
        studentId: data.studentId,
        assessmentId: data.assessmentId,
        courseId: data.courseId,
        content: data.content || '',
        status: actualStatus, // Usar el status real
        grade: data.grade,
        feedback: data.feedback,
        submittedAt: submittedAt,
        updatedAt: updatedAt,
        wordCount: data.wordCount || 0,
        characterCount: data.characterCount || 0,
        metadata: data.metadata || {}
      });
    });
      
      console.log('üìä Total entregas procesadas:', submissions.length);
      return submissions;
    } catch (error: any) {
      console.error('‚ùå Error cargando entregas directamente:', error);
      
      if (error.code === 'failed-precondition') {
        console.log('‚ö†Ô∏è Error de √≠ndice, intentando carga alternativa...');
        return await loadAllSubmissionsAndFilter(assessmentId);
      }
      
      toast.error('Error al cargar entregas: ' + error.message);
      return [];
    }
  };

  const loadAllSubmissionsAndFilter = async (assessmentId: string): Promise<any[]> => {
    try {
      console.log('üîç Cargando TODAS las entregas y filtrando...');
      
      const q = query(collection(db, 'submissions'));
      const querySnapshot = await getDocs(q);
      console.log('üìä Total documentos en colecci√≥n submissions:', querySnapshot.size);
      
      const submissions: any[] = [];
      
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        
        if (data.assessmentId === assessmentId) {
          let submittedAt = null;
          if (data.submittedAt) {
            if (data.submittedAt.toDate) {
              submittedAt = data.submittedAt.toDate();
            } else if (data.submittedAt.seconds) {
              submittedAt = new Date(data.submittedAt.seconds * 1000);
            }
          }
          
          submissions.push({
            id: doc.id,
            studentId: data.studentId,
            assessmentId: data.assessmentId,
            courseId: data.courseId,
            content: data.content || '',
            status: data.status || 'draft',
            submittedAt: submittedAt,
            wordCount: data.wordCount || 0,
            characterCount: data.characterCount || 0
          });
        }
      });
      
      console.log('‚úÖ Entregas filtradas manualmente:', submissions.length);
      return submissions;
    } catch (error) {
      console.error('‚ùå Error en carga alternativa:', error);
      return [];
    }
  };

  useEffect(() => {
    if (courseCode && assessmentId && user) {
      loadData();
    }
  }, [courseCode, assessmentId, user]);

  const loadData = async () => {
    setIsLoading(true);
    try {
      console.log('üì• Loading assessment:', assessmentId, 'for course code:', courseCode);
      
      const course = courses.find(c => c.code === courseCode);
      if (!course) {
        toast.error('Course not found');
        navigate('/courses');
        return;
      }
      
      setCourseId(course.id);
      setCourseName(course.name || 'Course');
      
      const assessmentData = await assessmentService.getAssessmentById(assessmentId!);
      console.log('üìä Assessment data:', assessmentData);
      
      if (!assessmentData) {
        toast.error('Assessment not found');
        navigate(`/courses/${courseCode}/assessments`);
        return;
      }
      setAssessment(assessmentData);

      const enrolledStudents = await enrollmentService.getEnrolledStudents(course.id);
      console.log('üë• Enrolled students:', enrolledStudents.length);
      
      let studentSubmissions: any[] = [];
      if (assessmentData.assessmentType === 'delivery') {
        try {
          console.log('üìù Loading student submissions for delivery activity');
          
          try {
            const submissions = await submissionService.getSubmissionsByAssessment(assessmentId!);
            console.log('‚úÖ Submissions loaded via service:', submissions.length);
            studentSubmissions = submissions;
          } catch (serviceError) {
            console.log('‚ö†Ô∏è Service failed, trying direct Firestore load...', serviceError);
            studentSubmissions = await loadSubmissionsDirectly(assessmentId!);
          }
          
        } catch (error) {
          console.error('‚ùå Error loading submissions:', error);
          toast.error('Error al cargar entregas de estudiantes');
        }
      }

      if (assessmentData.gradeSheetId) {
        console.log('üìã Loading grade sheet:', assessmentData.gradeSheetId);
        const sheet = await gradeSheetService.getById(assessmentData.gradeSheetId);
        console.log('‚úÖ Grade sheet loaded:', sheet?.title);
        setGradeSheet(sheet);
          
        const activity = sheet?.activities?.find((act: any) => 
          act.name === assessmentData.name || 
          act.id === assessmentData.id ||
          act.assessmentId === assessmentId
        );
        console.log('üîç Found activity:', activity);

        const studentsData: StudentGrade[] = enrolledStudents.map((student: any) => {
          const studentSubmission = studentSubmissions.find(
            (sub: any) => sub.studentId === student.id
          );
          
          console.log(`üîç Buscando entrega para estudiante ${student.id}:`, 
            studentSubmission ? 'ENCONTRADA' : 'NO ENCONTRADA');
          
          let gradeInfo = { 
            grade: undefined as number | undefined, 
            comment: '', 
            status: 'pending' as 'pending' | 'graded',
            submittedAt: null as Date | null
          };
          
          if (activity && sheet?.students) {
            const studentGrade = sheet.students.find((s: any) => s.studentId === student.id);
            
            if (studentGrade && studentGrade.grades && studentGrade.grades[activity.id]) {
              const gradeData = studentGrade.grades[activity.id];
              
              let submittedAt = null;
              if (gradeData.submittedAt) {
                if (gradeData.submittedAt instanceof Date) {
                  submittedAt = gradeData.submittedAt;
                } else if (typeof gradeData.submittedAt === 'string') {
                  submittedAt = new Date(gradeData.submittedAt);
                } else if (gradeData.submittedAt && typeof gradeData.submittedAt === 'object') {
                  if ('toDate' in gradeData.submittedAt) {
                    submittedAt = (gradeData.submittedAt as any).toDate();
                  } else if ('seconds' in gradeData.submittedAt) {
                    submittedAt = new Date((gradeData.submittedAt as any).seconds * 1000);
                  }
                }
              }
              
              gradeInfo = {
                grade: gradeData.value,
                comment: gradeData.comment || '',
                status: 'graded',
                submittedAt: submittedAt
              };
            }
          }
          
          return {
            studentId: student.id,
            name: student.name || `Student ${student.id.substring(0, 8)}`,
            email: student.email,
            grade: gradeInfo.grade,
            comment: gradeInfo.comment,
            status: gradeInfo.status,
            submittedAt: gradeInfo.submittedAt,
            submission: studentSubmission,
            hasSubmission: !!studentSubmission,
            submissionStatus: studentSubmission?.status || 'pending',
            submissionContent: studentSubmission?.content,
            wordCount: studentSubmission?.wordCount,
            characterCount: studentSubmission?.characterCount,
            submissionDate: studentSubmission?.submittedAt
          };
        });

        const sortedStudents = studentsData.sort((a, b) => {
          const nameA = a.name.toUpperCase();
          const nameB = b.name.toUpperCase();
          if (nameA < nameB) return -1;
          if (nameA > nameB) return 1;
          return 0;
        });

        setStudents(sortedStudents);
      } else {
        const studentsData: StudentGrade[] = enrolledStudents.map((student: any) => {
          const studentSubmission = studentSubmissions.find(
            (sub: any) => sub.studentId === student.id
          );
          
          console.log(`üìù Estudiante ${student.name} tiene entrega:`, !!studentSubmission);
          
          return {
            studentId: student.id,
            name: student.name || `Student ${student.id.substring(0, 8)}`,
            email: student.email,
            grade: undefined,
            comment: '',
            status: 'pending' as const,
            submission: studentSubmission,
            hasSubmission: !!studentSubmission,
            submissionStatus: studentSubmission?.status || 'pending',
            submissionContent: studentSubmission?.content,
            wordCount: studentSubmission?.wordCount,
            characterCount: studentSubmission?.characterCount,
            submissionDate: studentSubmission?.submittedAt
          };
        });

        const sortedStudents = studentsData.sort((a, b) => {
          const nameA = a.name.toUpperCase();
          const nameB = b.name.toUpperCase();
          if (nameA < nameB) return -1;
          if (nameA > nameB) return 1;
          return 0;
        });

        setStudents(sortedStudents);
        console.log('‚ö†Ô∏è No grade sheet ID found for assessment');
      }

    } catch (error) {
      console.error('‚ùå Error loading data:', error);
      toast.error('Failed to load assessment data');
    } finally {
      setIsLoading(false);
    }
  };

  const filteredStudents = students.filter(student => {
    const matchesSearch = searchTerm === '' || 
      student.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      student.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      student.studentId.toLowerCase().includes(searchTerm.toLowerCase());
    
    const matchesFilter = filterStatus === 'all' || 
      (filterStatus === 'with_submission' && student.hasSubmission) ||
      (filterStatus === 'without_submission' && !student.hasSubmission) ||
      (filterStatus === 'submitted' && student.submissionStatus === 'submitted') ||
      (filterStatus === 'draft' && student.submissionStatus === 'draft') ||
      (filterStatus === 'graded' && student.status === 'graded') ||
      (filterStatus === 'pending' && student.status === 'pending');
    
    return matchesSearch && matchesFilter;
  });

  const toggleSubmissionExpansion = (studentId: string) => {
    setExpandedSubmissions(prev => ({
      ...prev,
      [studentId]: !prev[studentId]
    }));
  };

  const downloadSubmission = (student: StudentGrade) => {
    if (!student.submissionContent) {
      toast.error('No hay contenido para descargar');
      return;
    }
    
    const blob = new Blob([student.submissionContent], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `entrega_${student.name.replace(/\s+/g, '_')}_${assessment?.name?.replace(/\s+/g, '_') || 'evaluacion'}.txt`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    toast.success(`Entrega de ${student.name} descargada`);
  };

  const updateStudentGrade = (index: number, field: 'grade' | 'comment', value: string | number) => {
    const studentId = filteredStudents[index]?.studentId;
    if (!studentId) return;
    
    const originalIndex = students.findIndex(s => s.studentId === studentId);
    if (originalIndex === -1) return;
    
    const newStudents = [...students];
    if (field === 'grade') {
      const numValue = value === '' ? undefined : Number(value);
      newStudents[originalIndex] = {
        ...newStudents[originalIndex],
        grade: numValue,
        status: numValue !== undefined ? 'graded' : 'pending',
        ...(numValue !== undefined && { submittedAt: new Date() })
      };
    } else {
      newStudents[originalIndex] = {
        ...newStudents[originalIndex],
        [field]: String(value)
      };
    }
    setStudents(newStudents);
  };

  const validateGrades = (): boolean => {
    if (!assessment) return false;
    
    for (const student of students) {
      if (student.grade !== undefined) {
        if (student.grade < 0 || student.grade > assessment.maxPoints) {
          toast.error(`La calificaci√≥n para ${student.name} debe estar entre 0 y ${assessment.maxPoints}`);
          return false;
        }
      }
    }
    return true;
  };

  const handleSaveGrades = async () => {
    if (!assessment || !user || !courseId || !assessmentId) return;
    
    if (!validateGrades()) return;
    
    setIsSaving(true);
      
    try {
      if (assessment.gradeSheetId) {
        console.log('üíæ Saving grades to grade sheet:', assessment.gradeSheetId);
        
        const sheet = await gradeSheetService.getById(assessment.gradeSheetId);
        if (!sheet) {
          toast.error('Grade sheet not found');
          return;
        }
          
        let activityId = sheet?.activities?.find((act: any) => 
          act.name === assessment.name || 
          act.id === assessment.id ||
          act.assessmentId === assessmentId
        )?.id;
        
        const currentActivities = sheet?.activities || [];
        let updatedActivities = [...currentActivities];
          
        if (!activityId) {
          activityId = `activity_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
          const newActivity = {
            id: activityId,
            name: assessment.name,
            description: assessment.description || '',
            maxScore: assessment.maxPoints,
            type: assessment.type || 'quiz',
            percentage: assessment.percentage || 0,
            weight: assessment.percentage || 0,
            passingScore: assessment.passingScore || 0,
            status: 'graded',
            createdAt: new Date(),
            assessmentId: assessmentId
          };
            
          updatedActivities.push(newActivity);
            
          await gradeSheetService.update(assessment.gradeSheetId, {
            activities: updatedActivities
          });
        }
          
        const updatedStudents = [...(sheet.students || [])];
        
        for (const student of students) {
          if (student.grade !== undefined) {
            const studentIndex = updatedStudents.findIndex((s: any) => s.studentId === student.studentId);
            
            const gradeData: FirestoreGrade = {
              value: student.grade,
              comment: student.comment || '',
              submittedAt: new Date()
            };
            
            if (studentIndex >= 0) {
              const existingStudent = updatedStudents[studentIndex];
              
              updatedStudents[studentIndex] = {
                ...existingStudent,
                grades: {
                  ...existingStudent.grades,
                  [activityId]: gradeData
                },
                status: 'completed'
              };
            } else {
              updatedStudents.push({
                studentId: student.studentId,
                name: student.name,
                grades: {
                  [activityId]: gradeData
                },
                status: 'completed'
              });
            }
            
            if (student.hasSubmission && student.submission?.id) {
              try {
                await submissionService.gradeSubmission(
                  student.submission.id,
                  student.grade,
                  student.comment,
                  user.id
                );
                console.log(`‚úÖ Submission ${student.submission.id} graded`);
              } catch (error) {
                console.error(`‚ùå Error grading submission for ${student.name}:`, error);
              }
            }
          }
        }
        
        await gradeSheetService.update(assessment.gradeSheetId, {
          students: updatedStudents,
          updatedAt: new Date(),
          isPublished: true
        });
          
        await assessmentService.updateAssessment(assessmentId, {
          status: 'graded'
        });
        
        toast.success('‚úÖ Calificaciones y comentarios guardados exitosamente');
        navigate(`/courses/${courseCode}/assessments/${assessmentId}`);
          
      } else {
        console.warn('‚ö†Ô∏è No grade sheet ID found, cannot save grades');
        toast.error('No hay hoja de calificaciones asociada a esta evaluaci√≥n');
        return;
      }
      
    } catch (error: any) {
      console.error('‚ùå Error saving grades:', error);
      toast.error(`Error al guardar calificaciones: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

const calculateStats = () => {
  const graded = students.filter(s => s.grade !== undefined && s.status === 'graded');
  const total = students.length;
  const average = graded.length > 0 
    ? graded.reduce((sum, s) => sum + (s.grade || 0), 0) / graded.length 
    : 0;
  const passing = graded.filter(s => (s.grade || 0) >= (assessment?.passingScore || 0)).length;
    
const submittedCount = students.filter(s => s.hasSubmission && s.submissionDate).length;
  const draftCount = students.filter(s => s.hasSubmission && !s.submissionDate).length;
  const noSubmissionCount = students.filter(s => !s.hasSubmission).length;
    
 return {
    total,
    graded: graded.length,
    average: average.toFixed(1),
    passingRate: total > 0 ? ((passing / total) * 100).toFixed(0) : '0',
    pending: total - graded.length,
    passingCount: passing,
    failingCount: graded.length - passing,
    submittedCount,
    draftCount,
    noSubmissionCount,
    submissionRate: total > 0 ? ((submittedCount / total) * 100).toFixed(0) : '0'
  };
};

  const stats = calculateStats();

  if (isLoading) {
    return (
      <DashboardLayout title="Calificar Evaluaci√≥n" subtitle="Cargando...">
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center space-y-4">
            <div className="h-12 w-12 mx-auto rounded-2xl bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center">
              <Loader2 className="h-8 w-8 text-blue-600 animate-spin" />
            </div>
            <div className="space-y-2">
              <p className="text-lg font-bold text-gray-900">Cargando evaluaci√≥n</p>
              <p className="text-sm text-gray-600">Preparando el entorno de calificaci√≥n</p>
            </div>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  if (!assessment) {
    return (
      <DashboardLayout title="Calificar Evaluaci√≥n" subtitle="Evaluaci√≥n no encontrada">
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center space-y-4">
            <div className="h-20 w-20 mx-auto rounded-2xl bg-gradient-to-br from-red-100 to-pink-100 flex items-center justify-center border border-red-200">
              <AlertCircle className="h-10 w-10 text-red-600" />
            </div>
            <div className="space-y-2">
              <h3 className="text-2xl font-bold text-gray-900">Evaluaci√≥n no encontrada</h3>
              <p className="text-gray-600">La evaluaci√≥n que buscas no existe o no tienes acceso.</p>
            </div>
            <button
              onClick={() => navigate(`/courses/${courseCode}/assessments`)}
              className="inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-600 text-white hover:shadow-lg transition-all duration-300"
            >
              <ArrowLeft className="h-4 w-4" />
              Volver a Evaluaciones
            </button>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout
      title={`Calificar: ${assessment.name}`}
      subtitle={courseName}
    >
      <div className="space-y-2">
        {/* Header - DISE√ëO MODERNO */}
        <div className="modern-card">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-6">
            <div className="flex items-center gap-4">
             
              <div>
                <h1 className="text-2xl font-bold text-gray-900">{assessment.name}</h1>
                <p className="text-gray-600">{courseName}</p>
              </div>
            </div>
            
            <div className="flex flex-wrap items-center gap-3">
            
              <button
                onClick={handleSaveGrades}
                disabled={isSaving}
                className="inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-600 text-white hover:shadow-lg transition-all duration-300 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isSaving ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin" />
                    Guardando...
                  </>
                ) : (
                  <>
                    <Save className="h-4 w-4" />
                    Guardar Calificaciones
                  </>
                )}
              </button>
            </div>
          </div>

          {/* Assessment Info - DISE√ëO MODERNO */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div className="bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center">
                  {getTypeIcon(assessment.type)}
                </div>
                <div>
                  <p className="text-sm text-blue-700 font-bold">Tipo de Evaluaci√≥n</p>
                  <p className="font-bold text-blue-900 capitalize">{assessment.type}</p>
                </div>
              </div>
            </div>
            
            <div className="bg-gradient-to-br from-emerald-50 to-green-50 border border-emerald-200 rounded-xl p-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-gradient-to-br from-emerald-100 to-green-100 flex items-center justify-center">
                  <Percent className="h-5 w-5 text-emerald-600" />
                </div>
                <div>
                  <p className="text-sm text-emerald-700 font-bold">Peso</p>
                  <p className="font-bold text-emerald-900">{assessment.percentage}%</p>
                </div>
              </div>
            </div>
            
            <div className="bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center">
                  <Trophy className="h-5 w-5 text-amber-600" />
                </div>
                <div>
                  <p className="text-sm text-amber-700 font-bold">Puntos M√°ximos</p>
                  <p className="font-bold text-amber-900">{assessment.maxPoints}</p>
                </div>
              </div>
            </div>
            
            <div className="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center">
                  <CheckCircle className="h-5 w-5 text-purple-600" />
                </div>
                <div>
                  <p className="text-sm text-purple-700 font-bold">Puntaje de Aprobaci√≥n</p>
                  <p className="font-bold text-purple-900">{assessment.passingScore}</p>
                </div>
              </div>
            </div>
          </div>

          {/* Statistics - DISE√ëO MODERNO */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div className="modern-card">
              <div className="text-center">
                <p className="text-sm text-gray-700 font-bold">Total Estudiantes</p>
                <p className="text-2xl font-bold text-gray-900">{stats.total}</p>
                <div className="mt-2 text-xs text-gray-500">
                  Inscritos en el curso
                </div>
              </div>
            </div>
            
            <div className="modern-card border-blue-200">
              <div className="text-center">
                <p className="text-sm text-blue-700 font-bold">Calificados</p>
                <p className="text-2xl font-bold text-blue-600">{stats.graded}</p>
                <div className="mt-2 text-xs text-blue-500">
                  {stats.pending} pendientes
                </div>
              </div>
            </div>
            
            <div className="modern-card border-emerald-200">
              <div className="text-center">
                <p className="text-sm text-emerald-700 font-bold">Promedio</p>
                <p className="text-2xl font-bold text-emerald-600">{stats.average}</p>
                <div className="mt-2 text-xs text-emerald-500">
                  de {assessment.maxPoints} puntos
                </div>
              </div>
            </div>
            
            <div className="modern-card border-purple-200">
              <div className="text-center">
                <p className="text-sm text-purple-700 font-bold">Tasa de Aprobaci√≥n</p>
                <p className="text-2xl font-bold text-purple-600">{stats.passingRate}%</p>
                <div className="mt-2 text-xs text-purple-500">
                  {stats.passingCount} de {stats.total}
                </div>
              </div>
            </div>
          </div>

          {/* Estad√≠sticas de entregas - DISE√ëO MODERNO */}
          {assessment.assessmentType === 'delivery' && (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div className="bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-blue-700 font-bold">Entregas Enviadas</p>
                    <p className="text-2xl font-bold text-blue-600">{stats.submittedCount}</p>
                  </div>
                  <div className="h-10 w-10 rounded-lg bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center">
                    <BookOpen className="h-5 w-5 text-blue-600" />
                  </div>
                </div>
                <p className="text-xs text-blue-500 mt-2">
                  {stats.submissionRate}% de los estudiantes
                </p>
              </div>
              
              <div className="bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-amber-700 font-bold">Borradores</p>
                    <p className="text-2xl font-bold text-amber-600">{stats.draftCount}</p>
                  </div>
                  <div className="h-10 w-10 rounded-lg bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center">
                    <Clock className="h-5 w-5 text-amber-600" />
                  </div>
                </div>
                <p className="text-xs text-amber-500 mt-2">
                  Pendientes de env√≠o
                </p>
              </div>
              
              <div className="bg-gradient-to-br from-red-50 to-pink-50 border border-red-200 rounded-xl p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-red-700 font-bold">Sin Entrega</p>
                    <p className="text-2xl font-bold text-red-600">{stats.noSubmissionCount}</p>
                  </div>
                  <div className="h-10 w-10 rounded-lg bg-gradient-to-br from-red-100 to-pink-100 flex items-center justify-center">
                    <AlertTriangle className="h-5 w-5 text-red-600" />
                  </div>
                </div>
                <p className="text-xs text-red-500 mt-2">
                  Requieren atenci√≥n
                </p>
              </div>
            </div>
          )}
        </div>

        {/* Tabs - DISE√ëO MODERNO */}
        {assessment.assessmentType === 'delivery' && (
          <div className="modern-card">
            <div className="border-b border-gray-200">
              <nav className="flex space-x-8">
                <button
                  onClick={() => setActiveTab('grades')}
                  className={`px-5 py-3 rounded-t-lg font-medium text-sm transition-all duration-300 flex items-center gap-2 ${
                    activeTab === 'grades'
                      ? 'bg-gradient-to-r from-blue-50 to-cyan-50 text-blue-700 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                  }`}
                >
                  <CheckCircle className="h-4 w-4" />
                  Calificaciones
                </button>
                
                <button
                  onClick={() => setActiveTab('submissions')}
                  className={`px-5 py-3 rounded-t-lg font-medium text-sm transition-all duration-300 flex items-center gap-2 ${
                    activeTab === 'submissions'
                      ? 'bg-gradient-to-r from-cyan-50 to-blue-50 text-cyan-700 border-b-2 border-cyan-600'
                      : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                  }`}
                >
                  <FileText className="h-4 w-4" />
                  Entregas de Estudiantes
                  <span className="ml-1 px-2 py-0.5 text-xs font-bold bg-gradient-to-r from-cyan-100 to-blue-100 text-cyan-800 rounded-full">
                    {stats.submittedCount}
                  </span>
                </button>
              </nav>
            </div>
          </div>
        )}

        {/* Barra de b√∫squeda y filtros - DISE√ëO MODERNO */}
        <div className="modern-card">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div className="flex-1">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type="text"
                  placeholder="Buscar estudiantes..."
                  className="w-full pl-11 pr-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm font-medium"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>
            </div>
            
            <div className="flex flex-wrap gap-3">
              <div className="relative">
                <Filter className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                <select
                  className="pl-10 pr-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 appearance-none text-sm font-medium"
                  value={filterStatus}
                  onChange={(e) => setFilterStatus(e.target.value)}
                >
                  <option value="all">Todos los estudiantes</option>
                  <option value="with_submission">Con entrega</option>
                  <option value="without_submission">Sin entrega</option>
                  <option value="submitted">Enviados</option>
                  <option value="draft">Borradores</option>
                  <option value="graded">Calificados</option>
                  <option value="pending">Pendientes</option>
                </select>
              </div>
              
            
            </div>
          </div>
        </div>

        {/* Grading Table - DISE√ëO MODERNO */}
        <div className="modern-card">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-6">
            <div className="flex items-center gap-3">
              <div className="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center">
                <Users className="h-5 w-5 text-blue-600" />
              </div>
              <div>
                <h2 className="text-xl font-bold text-gray-900">
                  {activeTab === 'submissions' ? 'Entregas de Estudiantes' : 'Calificaciones de Estudiantes'}
                </h2>
                <p className="text-sm text-gray-600">
                  {filteredStudents.length} de {students.length} estudiantes
                </p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              <div className="text-sm text-gray-600">
                Puntos m√°x: <span className="font-bold text-gray-900">{assessment.maxPoints}</span>
              </div>
              <div className="text-sm text-gray-600">
                Aprobaci√≥n: <span className="font-bold text-gray-900">{assessment.passingScore}</span>
              </div>
            </div>
          </div>

          <div className="overflow-x-auto rounded-xl border border-gray-200">
            <table className="w-full min-w-[800px]">
              <thead>
                <tr className="bg-gradient-to-r from-gray-50 to-gray-100">
                  <th className="py-4 px-6 text-left text-sm font-bold text-gray-900">Estudiante</th>
                  <th className="py-4 px-6 text-left text-sm font-bold text-gray-900">
                    Calificaci√≥n (0-{assessment.maxPoints})
                  </th>
                  <th className="py-4 px-6 text-left text-sm font-bold text-gray-900">
                    {activeTab === 'submissions' ? 'Estado Entrega' : 'Estado'}
                  </th>
                  <th className="py-4 px-6 text-left text-sm font-bold text-gray-900">Comentarios</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {filteredStudents.map((student, index) => {
                  const isPassing = student.grade !== undefined && student.grade >= assessment.passingScore;
                  const isGraded = student.status === 'graded' && student.grade !== undefined;
                  
                  let submissionStatusColor = '';
                  let submissionStatusText = '';
                  let submissionIcon = null;
                  
                  
                  if (student.hasSubmission) {
                    
                    switch (student.submissionStatus) {
                      case 'submitted': 
                        submissionStatusColor = 'bg-gradient-to-r from-blue-100 to-cyan-100 text-blue-700 border border-blue-200';
                        submissionStatusText = 'Submitted';
                        submissionIcon = <CheckCircle className="h-3 w-3" />;
                        break;
                      case 'draft':
                        submissionStatusColor = 'bg-gradient-to-r from-amber-100 to-orange-100 text-amber-700 border border-amber-200';
                        submissionStatusText = 'Draft';
                        submissionIcon = <Clock className="h-3 w-3" />;
                        break;
                      case 'graded':
                        submissionStatusColor = 'bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border border-emerald-200';
                        submissionStatusText = 'Graded';
                        submissionIcon = <CheckSquare className="h-3 w-3" />;
                        break;
                      default:
                        submissionStatusColor = 'bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 border border-gray-300';
                        submissionStatusText = 'Pending';
                        submissionIcon = <Clock className="h-3 w-3" />;
                    }
                  } else {
                    submissionStatusColor = 'bg-gradient-to-r from-red-100 to-pink-100 text-red-700 border border-red-200';
                    submissionStatusText = 'No Submission';
                    submissionIcon = <AlertTriangle className="h-3 w-3" />;
                  }
                  
                  return (
                    <>
                      <tr key={student.studentId} className="hover:bg-gradient-to-r hover:from-blue-50/30 hover:to-cyan-50/30 transition-all">
                        <td className="py-4 px-6">
                          <div className="flex items-center gap-4">
                            <div className="h-12 w-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold shadow-sm">
                              {student.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                              <p className="font-bold text-gray-900 text-sm">{student.name}</p>
                              <p className="text-xs text-gray-500">ID: {student.studentId.substring(0, 8)}...</p>
                              {student.email && (
                                <p className="text-xs text-gray-400">{student.email}</p>
                              )}
                            </div>
                          </div>
                        </td>
                        <td className="py-4 px-6">
                          <div className="flex items-center gap-3">
                            <div className="relative">
                              <input
                                type="number"
                                value={student.grade ?? ''}
                                onChange={(e) => updateStudentGrade(index, 'grade', e.target.value)}
                                className="w-32 px-4 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm font-medium [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                placeholder="Ingresar calificaci√≥n"
                                min={0}
                                max={assessment.maxPoints}
                                step="0.1"
                              />
                            </div>
                            <span className="text-sm text-gray-600 font-medium">
                              / {assessment.maxPoints}
                            </span>
                          </div>
                          {isGraded && student.submittedAt && (
                            <p className="text-xs text-gray-500 mt-2">
                              Calificado: {format(student.submittedAt, "dd/MM/yyyy", { locale: es })}
                            </p>
                          )}
                        </td>
                        <td className="py-4 px-6">
                          <div className="space-y-2">
                            <span className={`px-3 py-1.5 rounded-lg text-xs font-bold inline-flex items-center gap-1.5 w-32 justify-center ${
                              isGraded
                                ? isPassing
                                  ? 'bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border border-emerald-200'
                                  : 'bg-gradient-to-r from-red-100 to-pink-100 text-red-700 border border-red-200'
                                : 'bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 border border-gray-300'
                            }`}>
                              {isGraded
                                ? isPassing ? '‚úì Aprobado' : '‚úó No Aprobado'
                                : '‚è± Pendiente'}
                            </span>
                            
                            {assessment.assessmentType === 'delivery' && (
                              <div className="mt-2">
                                <span className={`px-3 py-1.5 rounded-lg text-xs font-bold inline-flex items-center gap-1.5 ${submissionStatusColor}`}>
                                  {submissionIcon}
                                  {submissionStatusText}
                                </span>
                                {student.hasSubmission && student.wordCount && (
                                  <p className="text-xs text-gray-500 mt-2">
                                    {student.wordCount} palabras ‚Ä¢ {student.characterCount} caracteres
                                  </p>
                                )}
                              </div>
                            )}
                          </div>
                        </td>
                        <td className="py-4 px-6">
                          <div className="relative">
                            <textarea
                              value={student.comment || ''}
                              onChange={(e) => updateStudentGrade(index, 'comment', e.target.value)}
                              placeholder="Agregar retroalimentaci√≥n o comentarios..."
                              rows={2}
                              className="w-full px-4 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm font-medium resize-none"
                            />
                            <MessageSquare className="h-4 w-4 text-gray-400 absolute right-3 top-3" />
                          </div>
                          {student.comment && (
                            <p className="text-xs text-gray-500 mt-2">
                              {student.comment.length} caracteres
                            </p>
                          )}
                        </td>
                      </tr>
                      
                      {/* Fila expandida para entrega */}
                      {assessment.assessmentType === 'delivery' && student.hasSubmission && activeTab === 'submissions' && (
                        <tr className="bg-gradient-to-r from-gray-50/50 to-gray-100/50">
                          <td colSpan={4} className="p-4">
                            <div className="modern-card">
                              <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-4">
                                <div className="flex items-center gap-3">
                                  <div className="h-10 w-10 rounded-lg bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center">
                                    <File className="h-5 w-5 text-blue-600" />
                                  </div>
                                  <div>
                                    <h3 className="font-bold text-gray-900">{student.name}</h3>
                                    <div className="flex items-center gap-2 mt-1">
                                      <span className={`px-2 py-0.5 text-xs font-bold rounded-full ${submissionStatusColor}`}>
                                        {submissionStatusText}
                                      </span>
                                      {student.wordCount && (
                                        <span className="text-xs text-gray-500">
                                          ‚Ä¢ {student.wordCount} palabras ‚Ä¢ {student.characterCount} caracteres
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                                <div className="flex items-center gap-2">
                                  <button
                                    onClick={() => toggleSubmissionExpansion(student.studentId)}
                                    className="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 hover:from-gray-200 hover:to-gray-300 transition-all duration-300 font-medium border border-gray-300"
                                  >
                                    {expandedSubmissions[student.studentId] ? (
                                      <>
                                        <ChevronUp className="h-4 w-4" />
                                        Ocultar
                                      </>
                                    ) : (
                                      <>
                                        <ChevronDown className="h-4 w-4" />
                                        Ver Entrega
                                      </>
                                    )}
                                  </button>
                                  <button
                                    onClick={() => downloadSubmission(student)}
                                    disabled={!student.submissionContent}
                                    className="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl bg-gradient-to-r from-cyan-100 to-blue-100 text-cyan-700 hover:from-cyan-200 hover:to-blue-200 transition-all duration-300 font-medium border border-cyan-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                  >
                                    <Download className="h-4 w-4" />
                                    Descargar
                                  </button>
                                </div>
                              </div>
                              
                              {expandedSubmissions[student.studentId] && student.submissionContent && (
                                <div className="mt-4">
                                  <div className="bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200 rounded-xl p-4 max-h-96 overflow-y-auto">
                                    <pre className="text-gray-700 whitespace-pre-wrap font-sans text-sm">
                                      {student.submissionContent}
                                    </pre>
                                  </div>
                                  
                                  {student.submissionDate && (
                                    <div className="mt-3 text-sm text-gray-600 flex items-center gap-2">
                                      <CalendarClock className="h-4 w-4 text-gray-500" />
                                      Enviado el: {format(student.submissionDate, "dd/MM/yyyy HH:mm", { locale: es })}
                                    </div>
                                  )}
                                  
                                  {student.submission?.feedback && (
                                    <div className="mt-4 p-3 bg-gradient-to-r from-blue-50/50 to-cyan-50/50 border border-blue-200 rounded-xl">
                                      <h4 className="font-bold text-blue-900 mb-1">Retroalimentaci√≥n anterior:</h4>
                                      <p className="text-sm text-blue-800">{student.submission.feedback}</p>
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </td>
                        </tr>
                      )}
                    </>
                  );
                })}
              </tbody>
            </table>
          </div>

          {filteredStudents.length === 0 && (
            <div className="text-center py-12">
              <Users className="h-16 w-16 text-gray-300 mx-auto mb-4" />
              <h3 className="text-lg font-bold text-gray-900 mb-2">No hay estudiantes que coincidan con los filtros</h3>
              <p className="text-gray-500">Intenta con otros t√©rminos de b√∫squeda o filtros.</p>
              <button
                onClick={() => {
                  setSearchTerm('');
                  setFilterStatus('all');
                }}
                className="inline-flex items-center gap-2 px-5 py-2.5 mt-4 rounded-xl bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 hover:from-gray-200 hover:to-gray-300 transition-all duration-300 font-medium border border-gray-300"
              >
                Limpiar filtros
              </button>
            </div>
          )}
        </div>

        {/* Summary - DISE√ëO MODERNO */}
        <div className="modern-card">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-6">
            <div className="flex items-center gap-3">
              <div className="h-10 w-10 rounded-xl bg-gradient-to-br from-emerald-100 to-green-100 flex items-center justify-center">
                <BarChart3 className="h-5 w-5 text-emerald-600" />
              </div>
              <div>
                <h3 className="font-bold text-gray-900">Resumen de Calificaciones</h3>
                <p className="text-sm text-gray-600">Estad√≠sticas generales del proceso de calificaci√≥n</p>
              </div>
            </div>
            
            <div className="flex flex-wrap gap-4">
              <div className="text-center">
                <p className="text-sm text-gray-700">Calificados</p>
                <p className="text-lg font-bold text-blue-600">{stats.graded}/{stats.total}</p>
              </div>
              <div className="text-center">
                <p className="text-sm text-gray-700">Pendientes</p>
                <p className="text-lg font-bold text-amber-600">{stats.pending}</p>
              </div>
              <div className="text-center">
                <p className="text-sm text-gray-700">Aprobados</p>
                <p className="text-lg font-bold text-emerald-600">{stats.passingCount}</p>
              </div>
              <div className="text-center">
                <p className="text-sm text-gray-700">No Aprobados</p>
                <p className="text-lg font-bold text-red-600">{stats.failingCount}</p>
              </div>
            </div>
          </div>
          
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div className="bg-gradient-to-br from-blue-50/50 to-cyan-50/50 border border-blue-200 rounded-xl p-4">
              <p className="text-sm text-blue-700 font-bold mb-2">Detalles de la Evaluaci√≥n</p>
              <p className="text-blue-900">
                {assessment.name} ‚Ä¢ {assessment.type} ‚Ä¢ {assessment.percentage}% del curso
              </p>
            </div>
            
            <div className="bg-gradient-to-br from-emerald-50/50 to-green-50/50 border border-emerald-200 rounded-xl p-4">
              <p className="text-sm text-emerald-700 font-bold mb-2">Resumen de Rendimiento</p>
              <p className="text-emerald-900">
                Promedio: {stats.average} ‚Ä¢ Aprobaci√≥n: {stats.passingRate}%
              </p>
            </div>
            
            <div className="bg-gradient-to-br from-amber-50/50 to-orange-50/50 border border-amber-200 rounded-xl p-4">
              <p className="text-sm text-amber-700 font-bold mb-2">
                {assessment.assessmentType === 'delivery' ? 'Entregas Recibidas' : 'Hoja de Calificaciones'}
              </p>
              <p className="text-amber-900">
                {assessment.assessmentType === 'delivery' 
                  ? `${stats.submittedCount} enviadas de ${stats.total} estudiantes`
                  : assessment.gradeSheetId 
                    ? 'Vinculada a hoja de calificaciones'
                    : 'No hay hoja de calificaciones vinculada'}
              </p>
            </div>
          </div>
        </div>

        {/* Footer Actions - DISE√ëO MODERNO */}
        <div className="modern-card">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
            <div>
              <p className="text-sm text-gray-600">
                Las calificaciones y comentarios ser√°n guardados en la hoja de calificaciones y marcados como "calificados".
              </p>
              <p className="text-xs text-gray-500 mt-1">
                Los estudiantes podr√°n ver sus calificaciones una vez publicadas.
              </p>
            </div>
            
            <div className="flex flex-col sm:flex-row gap-3">
              <button
                onClick={() => navigate(`/courses/${courseCode}/assessments/${assessmentId}`)}
                className="px-5 py-3 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-50 transition-all duration-300 font-medium"
              >
                Cancelar
              </button>
              
              <button
                onClick={handleSaveGrades}
                disabled={isSaving}
                className="px-5 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-600 text-white hover:shadow-lg transition-all duration-300 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isSaving ? (
                  <span className="flex items-center gap-2">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    Guardando Calificaciones...
                  </span>
                ) : (
                  <span className="flex items-center gap-2">
                    <Save className="h-4 w-4" />
                    Guardar Todas las Calificaciones
                  </span>
                )}
              </button>
            </div>
          </div>
        </div>
      </div>
    </DashboardLayout>
  );
}